<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Himariri Image Vault — เว็บแอปเก็บรูปและข้อมูล</title>
  <style>
    :root{--glass-bg: rgba(255,255,255,0.08);--glass-border: rgba(255,255,255,0.12);--accent: rgba(255,255,255,0.95)}
    html,body{height:100%;margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial}
    body{
      background-image: url('https://images.unsplash.com/photo-1503264116251-35a269479413?auto=format&fit=crop&w=1600&q=70');
      background-size:cover;background-position:center;backdrop-filter: blur(6px);
      color:var(--accent);
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
      display:flex;align-items:center;justify-content:center;padding:32px;box-sizing:border-box;
    }
    .app{
      width:100%;max-width:1100px;background:linear-gradient(135deg, rgba(6,17,40,0.6), rgba(12,30,60,0.45));border-radius:18px;padding:22px;box-shadow:0 10px 40px rgba(5,10,20,0.6);
      backdrop-filter: blur(8px);border:1px solid rgba(255,255,255,0.06);
    }
    header{display:flex;align-items:center;gap:16px;margin-bottom:18px}
    header h1{margin:0;font-size:20px}
    .controls{display:flex;gap:12px;flex-wrap:wrap}
    .card{background:var(--glass-bg);border:1px solid var(--glass-border);padding:12px;border-radius:12px}
    .upload{display:flex;flex-direction:column;gap:8px}
    label.file{cursor:pointer;padding:10px;border-radius:10px;border:1px dashed rgba(255,255,255,0.06);display:inline-block}
    input[type='file']{display:none}
    .meta{display:flex;gap:8px}
    .meta input,.meta textarea{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--accent);padding:8px;border-radius:8px;min-width:0}
    .btn{background:linear-gradient(90deg,#6f62ff,#56c6ff);color:#051028;border:none;padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:600}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.08);color:var(--accent)}
    .search{margin-left:auto;display:flex;gap:8px}
    .gallery{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px;margin-top:18px}
    .item{position:relative;overflow:hidden;border-radius:12px}
    .item img{width:100%;height:170px;object-fit:cover;display:block}
    .item .info{position:absolute;left:0;right:0;bottom:0;padding:8px;background:linear-gradient(180deg,transparent,rgba(0,0,0,0.6));color:white}
    .small{font-size:12px;opacity:0.9}
    .actions{display:flex;gap:8px;margin-top:8px}
    .kbd{background:rgba(255,255,255,0.06);padding:4px 8px;border-radius:6px;font-size:12px}
    footer{margin-top:14px;display:flex;justify-content:space-between;align-items:center}
    @media (max-width:600px){.meta{flex-direction:column}.gallery{grid-template-columns:repeat(auto-fill,minmax(150px,1fr))}}
  </style>
</head>
<body>
  <div class="app" role="application">
    <header>
      <div>
        <h1>Anoulurk Image Vault</h1>
        <div class="small">ເກັບຂໍ້ມູນແລະຮູບພາບ — ຮອງຮັບການອັບໂຫລດຫລາຍຮູບ ຄົ້ນຫາ ລົບ ແລະ ດາວໂຫລດ</div>
      </div>
      <div class="search" style="margin-left:auto">
        <input id="q" class="card" placeholder="ค้นหาโดยชื่อหรือคำอธิบาย" style="padding:8px;border-radius:10px;min-width:220px" />
        <button id="searchBtn" class="btn ghost">ຄົ້ນຫາ</button>
      </div>
    </header>

    <section class="card upload">
      <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
        <label class="file">
          ເລືອກຮູບພາບ
          <input id="file" type="file" accept="image/*" multiple />
        </label>
        <div class="meta" style="flex:1">
          <input id="title" placeholder="ຊື່ຮູບ (optional)" />
          <input id="tags" placeholder="ຄຳຄົ້ນຫາ (ຄັ່ນດ້ວຍ , )" />
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <button id="addBtn" class="btn">ອັບໂຫລດ</button>
          <button id="clearBtn" class="btn ghost">ລ້າງຖານຂໍ້ມູນ</button>
        </div>
      </div>
      <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">
        <div class="kbd">ຈັດເກັບດ້ວຍ IndexedDB</div>
        <div class="kbd">ຮອບຮັບຮູບຈຳນວນຫລາຍ (ຂື້ນກັບພື້ນທີ່ຂອງbrowser)</div>
        <div class="kbd">ສຳຮອງ: Export / Import</div>
      </div>
    </section>

    <section id="gallery" class="gallery"></section>

    <footer>
      <div class="small" style="font-size: 1.2rem;">Anoulurk — ສ້າງໂດຍ Anoulurk Hansamak</div>
      <div style="display:flex;gap:8px">
        <button id="exportBtn" class="btn ghost">Export JSON</button>
        <button id="importBtn" class="btn ghost">Import JSON</button>
        <input id="importFile" type="file" accept="application/json" style="display:none" />
      </div>
    </footer>
  </div>

<script>
/* ===== IndexedDB helper ===== */
const DB_NAME = 'himariri-images';
const STORE = 'images-v1';
let dbPromise = null;

function openDB(){
  if(dbPromise) return dbPromise;
  dbPromise = new Promise((resolve,reject)=>{
    const req = indexedDB.open(DB_NAME,1);
    req.onupgradeneeded = e => {
      const db = e.target.result;
      if(!db.objectStoreNames.contains(STORE)){
        db.createObjectStore(STORE, { keyPath: 'id', autoIncrement: true });
      }
    };
    req.onsuccess = e => resolve(e.target.result);
    req.onerror = e => reject(e.target.error);
  });
  return dbPromise;
}

async function addImageToDB(blob,meta){
  const db = await openDB();
  return new Promise((res,rej)=>{
    const tx = db.transaction(STORE,'readwrite');
    const store = tx.objectStore(STORE);
    const putReq = store.add({blob, meta, created: Date.now()});
    putReq.onsuccess = e => res(e.target.result);
    putReq.onerror = e => rej(e.target.error);
  });
}

async function getAllImages(){
  const db = await openDB();
  return new Promise((res,rej)=>{
    const tx = db.transaction(STORE,'readonly');
    const store = tx.objectStore(STORE);
    const req = store.getAll();
    req.onsuccess = () => res(req.result);
    req.onerror = e => rej(e.target.error);
  });
}

async function deleteImage(id){
  const db = await openDB();
  return new Promise((res,rej)=>{
    const tx = db.transaction(STORE,'readwrite');
    const store = tx.objectStore(STORE);
    const req = store.delete(id);
    req.onsuccess = () => res();
    req.onerror = e => rej(e.target.error);
  });
}

async function clearDB(){
  const db = await openDB();
  return new Promise((res,rej)=>{
    const tx = db.transaction(STORE,'readwrite');
    const store = tx.objectStore(STORE);
    const req = store.clear();
    req.onsuccess = () => res();
    req.onerror = e => rej(e.target.error);
  });
}

/* ===== UI logic ===== */
const fileEl = document.getElementById('file');
const addBtn = document.getElementById('addBtn');
const gallery = document.getElementById('gallery');
const q = document.getElementById('q');
const searchBtn = document.getElementById('searchBtn');
const titleEl = document.getElementById('title');
const tagsEl = document.getElementById('tags');
const clearBtn = document.getElementById('clearBtn');
const exportBtn = document.getElementById('exportBtn');
const importBtn = document.getElementById('importBtn');
const importFile = document.getElementById('importFile');

async function render(filter){
  gallery.innerHTML = '';
  const imgs = await getAllImages();
  const filtered = imgs.filter(item => {
    if(!filter) return true;
    const s = filter.toLowerCase();
    const t = (item.meta.title||'') + ' ' + (item.meta.tags||'') + ' ' + (item.meta.desc||'');
    return t.toLowerCase().includes(s);
  }).sort((a,b)=>b.created - a.created);

  for(const item of filtered){
    const url = URL.createObjectURL(item.blob);
    const el = document.createElement('div'); el.className='item card';
    el.innerHTML = `
      <img src="${url}" alt="${(item.meta.title||'image')}" />
      <div class="info">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div style="font-weight:700">${escapeHtml(item.meta.title||'ບໍ່ລະບຸຊື່')}</div>
            <div class="small">${new Date(item.created).toLocaleString()}</div>
          </div>
        </div>
        <div class="actions">
          <button class="btn ghost" data-id="${item.id}" data-action="download">ດາວໂຫລດ</button>
          <button class="btn ghost" data-id="${item.id}" data-action="delete">ລົບ</button>
        </div>
      </div>
    `;
    gallery.appendChild(el);

    // cleanup objectURL when removed
    el.querySelector('img').onload = () => URL.revokeObjectURL(url);
  }
}

function escapeHtml(s){return (s||'').replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]));}

addBtn.addEventListener('click', async ()=>{
  const files = Array.from(fileEl.files);
  if(files.length===0){ alert('ກະລຸນາເລືອກຮູບພາບກ່ອນ'); return; }
  const title = titleEl.value.trim();
  const tags = tagsEl.value.trim();
  for(const f of files){
    // read as blob (we can store file directly)
    const meta = {title, tags, name: f.name};
    await addImageToDB(f, meta);
  }
  fileEl.value=''; titleEl.value=''; tagsEl.value='';
  await render(q.value);
});

gallery.addEventListener('click', async (e)=>{
  const btn = e.target.closest('button[data-id]');
  if(!btn) return;
  const id = Number(btn.dataset.id);
  const action = btn.dataset.action;
  if(action==='delete'){
    if(!confirm('ต้องการลบรูปนี้จริงหรือไม่?')) return;
    await deleteImage(id); await render(q.value);
  } else if(action==='download'){
    // fetch object from DB and create download link
    const db = await openDB();
    const tx = db.transaction(STORE,'readonly');
    const store = tx.objectStore(STORE);
    const req = store.get(id);
    req.onsuccess = ()=>{
      const rec = req.result;
      if(!rec) return alert('ບໍ່ພົບຂໍ້ມູນ');
      const url = URL.createObjectURL(rec.blob);
      const a = document.createElement('a'); a.href=url; a.download = (rec.meta.name || 'image');
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }
  }
});

searchBtn.addEventListener('click', ()=> render(q.value));
q.addEventListener('keyup', e=>{ if(e.key==="Enter") render(q.value); });

clearBtn.addEventListener('click', async ()=>{
  if(confirm('ລ້າງຖານຂໍ້ມູນທັງຫມົດ? ການກະທຳນີ້ບໍ່ສາມາດຍ້ອນກັບໄດ້')){
    await clearDB(); await render();
  }
});

// export & import simple JSON backup (blobs converted to base64)
function blobToBase64(blob){
  return new Promise(resolve=>{
    const fr = new FileReader(); fr.onload = ()=> resolve(fr.result.split(',')[1]); fr.readAsDataURL(blob);
  });
}

exportBtn.addEventListener('click', async ()=>{
  const imgs = await getAllImages();
  const out = [];
  for(const it of imgs){
    const b64 = await blobToBase64(it.blob);
    out.push({id:it.id, meta:it.meta, created:it.created, b64});
  }
  const blob = new Blob([JSON.stringify(out)],{type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'himariri_images_backup.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
});

importBtn.addEventListener('click', ()=> importFile.click());
importFile.addEventListener('change', async ()=>{
  const f = importFile.files[0]; if(!f) return;
  const txt = await f.text();
  try{
    const data = JSON.parse(txt);
    for(const it of data){
      const bin = base64ToBlob(it.b64);
      // keep meta and created
      const db = await openDB();
      await new Promise((res,rej)=>{
        const tx = db.transaction(STORE,'readwrite');
        const store = tx.objectStore(STORE);
        store.add({blob:bin, meta:it.meta, created:it.created}).onsuccess = ()=>res();
      });
    }
    alert('ນຳເຂົ້າສຳເລັດແລ້ວ');
    await render();
  }catch(err){ alert('File ບໍ່ຖືກຕ້ອງ'); }
});

function base64ToBlob(b64){
  const byteChars = atob(b64);
  const byteNumbers = new Array(byteChars.length);
  for (let i = 0; i < byteChars.length; i++) byteNumbers[i] = byteChars.charCodeAt(i);
  const byteArray = new Uint8Array(byteNumbers);
  return new Blob([byteArray]);
}

// initial render
render();
</script>
</body>
</html>
